name: Release Desktop

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # Job 1: Auto-Tagging (Only runs on manual trigger)
  create_tag:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    outputs:
      new_tag: ${{ steps.tag_step.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Calculate and Push Tag
        id: tag_step
        run: |
          echo "Manual trigger detected. Calculating new version..."
          YEAR_MONTH=$(date +'%Y.%m')
          git fetch --tags
          LAST_TAG=$(git tag -l "v$YEAR_MONTH-*" | sort -V | tail -n 1)
          
          if [ -z "$LAST_TAG" ]; then
             NEW_TAG="v$YEAR_MONTH-1"
          else
             REV=${LAST_TAG##*-}
             NEXT_REV=$((REV + 1))
             NEW_TAG="v$YEAR_MONTH-$NEXT_REV"
          fi
          
          echo "Generated Tag: $NEW_TAG"
          git tag $NEW_TAG
          git push origin $NEW_TAG
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

  # Job 2: Define Version (Run for all triggered builds to normalize version tag)
  define_version:
    runs-on: ubuntu-latest
    if: always()
    needs: create_tag
    outputs:
      version: ${{ steps.define.outputs.version }}
    steps:
      - id: define
        run: |
          if [ "${{ needs.create_tag.result }}" == "success" ]; then
             echo "version=${{ needs.create_tag.outputs.new_tag }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
             echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
             echo "version=0.0.0-dev" >> $GITHUB_OUTPUT
          fi


  # Job 4: Build Linux
  build-linux:
    runs-on: ubuntu-latest
    needs: [create_tag, define_version]
    if: |
      always() && 
      (needs.create_tag.result == 'success' || (needs.create_tag.result == 'skipped' && startsWith(github.ref, 'refs/tags/v')))
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-4-dev libadwaita-1-dev python3-dev libpython3-dev cargo
          
      - name: Build
        run: |
          export PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1
          cargo build --release --manifest-path launcher/Cargo.toml
          
      - name: Bundle
        run: |
          mkdir -p dist/NeoCalc
          cp target/release/launcher dist/NeoCalc/NeoCalc
          cp -r python dist/NeoCalc/
          cp README.md dist/NeoCalc/
          tar -czf NeoCalc-Linux.tar.gz -C dist/NeoCalc .

      - name: Release Linux
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.define_version.outputs.version }}
          name: Release ${{ needs.define_version.outputs.version }}
          files: NeoCalc-Linux.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 5: Build Flatpak
  build-flatpak:
    runs-on: ubuntu-latest
    needs: [create_tag, define_version]
    if: |
      always() && 
      (needs.create_tag.result == 'success' || (needs.create_tag.result == 'skipped' && startsWith(github.ref, 'refs/tags/v')))
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

      - name: Build Flatpak
        run: |
          # Create a simple manifest if it doesn't exist
          if [ ! -f com.niltonperimneto.neocalc.yml ]; then
            cat > com.niltonperimneto.neocalc.yml << 'EOF'
          app-id: com.niltonperimneto.neocalc
          runtime: org.gnome.Platform
          runtime-version: '49'
          sdk: org.gnome.Sdk
          sdk-extensions:
            - org.freedesktop.Sdk.Extension.rust-stable
          command: neocalc
          modules:
            - name: neocalc
              buildsystem: simple
              build-options:
                build-args:
                  - --share=network
              build-commands:
                - . /usr/lib/sdk/rust-stable/enable.sh && cargo build --release --manifest-path launcher/Cargo.toml
                - install -Dm755 target/release/launcher /app/bin/neocalc
                - mkdir -p /app/share/neocalc
                - cp -r python /app/share/neocalc/
              sources:
                - type: dir
                  path: .
          EOF
          fi
          flatpak-builder --user --install-deps-from=flathub --disable-rofiles-fuse --repo=repo build-dir com.niltonperimneto.neocalc.yml
          flatpak build-bundle repo neocalc.flatpak com.niltonperimneto.neocalc
      
      - name: Release Flatpak
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.define_version.outputs.version }}
          name: Release ${{ needs.define_version.outputs.version }}
          files: neocalc.flatpak
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 6: Build Windows
  build-windows:
    runs-on: windows-latest
    needs: [create_tag, define_version]
    if: |
      always() && 
      (needs.create_tag.result == 'success' || (needs.create_tag.result == 'skipped' && startsWith(github.ref, 'refs/tags/v')))
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-rust
            mingw-w64-ucrt-x86_64-gtk4
            mingw-w64-ucrt-x86_64-libadwaita
            mingw-w64-ucrt-x86_64-python
            mingw-w64-ucrt-x86_64-python-gobject
            mingw-w64-ucrt-x86_64-gettext
            diffutils
          msystem: UCRT64
          
      - name: Build
        shell: msys2 {0}
        run: |
          export PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1
          cargo build --release --manifest-path launcher/Cargo.toml
          
      - name: Bundle
        shell: msys2 {0}
        run: |
          mkdir -p dist/NeoCalc
          cp target/release/launcher.exe dist/NeoCalc/NeoCalc.exe
          cp -r python dist/NeoCalc/
          
          # Copy dependencies using ldd
          ldd target/release/launcher.exe | grep '/ucrt64' | awk '{print $3}' | sort | uniq | xargs -I {} cp {} dist/NeoCalc/
          
          # Copy Resources (Schemas, Icons, etc.)
          mkdir -p dist/NeoCalc/share/glib-2.0/schemas
          cp /ucrt64/share/glib-2.0/schemas/gschemas.compiled dist/NeoCalc/share/glib-2.0/schemas/
          # Also copy source xmls just in case, or recompile. Best practice is to compile a new one if we had custom schemas, 
          # but here we rely on system ones mostly. We should copy the adwaita/gtk schemas.
          cp /ucrt64/share/glib-2.0/schemas/*.xml dist/NeoCalc/share/glib-2.0/schemas/
          glib-compile-schemas dist/NeoCalc/share/glib-2.0/schemas/
          
          mkdir -p dist/NeoCalc/share/icons
          cp -r /ucrt64/share/icons/Adwaita dist/NeoCalc/share/icons/
          cp -r /ucrt64/share/icons/hicolor dist/NeoCalc/share/icons/
          
          # Copy GDK Pixbuf Loaders (SVG Support)
          mkdir -p dist/NeoCalc/lib/gdk-pixbuf-2.0/2.10.0/loaders
          cp /ucrt64/lib/gdk-pixbuf-2.0/2.10.0/loaders/*.dll dist/NeoCalc/lib/gdk-pixbuf-2.0/2.10.0/loaders/
          cp /ucrt64/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache dist/NeoCalc/lib/gdk-pixbuf-2.0/2.10.0/
          # Sanitize cache paths (remove absolute /ucrt64 prefix to make it relocatable-ish)
          sed -i 's|/ucrt64/||g' dist/NeoCalc/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache
          
          # Copy Python Standard Library
          mkdir -p dist/NeoCalc/lib
          cp -r /ucrt64/lib/python3.* dist/NeoCalc/lib/
          
      - name: Zip Bundle
        shell: msys2 {0}
        run: |
          cd dist
          zip -r ../NeoCalc-Windows.zip NeoCalc
          
      - name: Release Windows
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.define_version.outputs.version }}
          name: Release ${{ needs.define_version.outputs.version }}
          files: NeoCalc-Windows.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
